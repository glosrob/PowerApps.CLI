name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.1.0)'
        required: true
        type: string

permissions:
  contents: write
  id-token: write

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Determine version
      id: version
      shell: pwsh
      run: |
        if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
          $version = '${{ inputs.version }}'
        } else {
          $version = '${{ github.ref_name }}'.TrimStart('v')
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"

    - name: Restore dependencies
      run: dotnet restore

    - name: Run tests
      run: dotnet test --verbosity normal

    - name: Build Self-Contained Single-File Executable (win-x64)
      run: |
        dotnet publish src/PowerApps.CLI/PowerApps.CLI.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishTrimmed=false `
          -p:EnableCompressionInSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:Version=${{ steps.version.outputs.VERSION }} `
          -o artifacts/self-contained

    - name: Pack .NET Tool (nupkg)
      run: |
        dotnet pack src/PowerApps.CLI/PowerApps.CLI.csproj `
          -c Release `
          -p:Version=${{ steps.version.outputs.VERSION }} `
          -o artifacts/nupkg

    - name: Package Single-File Executable
      shell: pwsh
      run: |
        # Create a standalone zip with just the exe
        Compress-Archive -Path artifacts/self-contained/powerapps-cli.exe `
          -DestinationPath powerapps-cli-win-x64-v${{ steps.version.outputs.VERSION }}.zip

    - name: Generate Release Notes
      id: release_notes
      shell: pwsh
      run: |
        $version = "v${{ steps.version.outputs.VERSION }}"
        $notes = @"
        ## PowerApps.CLI $version
        
        ### Installation

        #### Option 1: .NET Tool (recommended for CI/CD pipelines)
        ``````powershell
        dotnet tool install --global XRT.PowerApps.CLI --version ${{ steps.version.outputs.VERSION }}
        ``````

        #### Option 2: Self-Contained Executable
        Download ``powerapps-cli-win-x64-v${{ steps.version.outputs.VERSION }}.zip`` and extract.

        This is a **self-contained single-file executable** (~40 MB):
        - ✅ No .NET Runtime required
        - ✅ No dependencies
        - ✅ Just extract and run ``powerapps-cli.exe``
        - ✅ Works on any Windows x64 machine
        
        ### Usage
        ``````powershell
        powerapps-cli --help
        powerapps-cli schema-export --help
        powerapps-cli constants-generate --help
        powerapps-cli refdata-compare --help
        powerapps-cli process-manage --help
        ``````
        "@
        
        # Save to file for GitHub Release
        $notes | Out-File -FilePath release_notes.md -Encoding utf8
        echo "NOTES_FILE=release_notes.md" >> $env:GITHUB_OUTPUT

    - name: NuGet login (Trusted Publishing)
      uses: nuget/login@v1
      id: nuget-login
      with:
        user: glosrob

    - name: Publish to NuGet
      run: >
        dotnet nuget push artifacts/nupkg/XRT.PowerApps.CLI.${{ steps.version.outputs.VERSION }}.nupkg
        --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }}
        --source https://api.nuget.org/v3/index.json

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release v${{ steps.version.outputs.VERSION }}
        body_path: ${{ steps.release_notes.outputs.NOTES_FILE }}
        files: |
          powerapps-cli-win-x64-v${{ steps.version.outputs.VERSION }}.zip
          artifacts/nupkg/XRT.PowerApps.CLI.${{ steps.version.outputs.VERSION }}.nupkg
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
